name: Build, Push and Deploy (frontend + backend)

on:
  push:
    branches: [ "main" ]

env:
  SHORT_TAG: ${{ github.sha }}

  # Harbor registry/project (both images will live under REGISTRY/PROJECT)
  REGISTRY: docker-registry.ebrains.eu
  PROJECT: ebrains-data-curation

  # Kubernetes namespace (where Deployments exist)
  K8S_NAMESPACE: metadata-wizard-dev

  # Full image names (registry/project/repo)
  DEV_WIZARD_IMAGE: docker-registry.ebrains.eu/ebrains-data-curation/metadata-wizard-dev/image-wizard-dev
  
  # Container names inside the Deployments (must match k8s manifests)
  WIZARD_CONTAINER: container-dev-wizard

  # Kubernetes Deployment names (adjust to your real names)
  WIZARD_DEPLOYMENT: dev-wizard-deployment

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Debug TLS
        run: |
          curl -v https://docker-registry.ebrains.eu/v2/ 

      - name: Log in to Harbor
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.HARBOR_USERNAME }}
          password: ${{ secrets.HARBOR_PASSWORD }}

      - name: Build & push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DEV_WIZARD_IMAGE }}:${{ env.SHORT_TAG }}
            ${{ env.DEV_WIZARD_IMAGE }}:latest

      - name: Write kubeconfig (base64)
        env:
          KUBECONFIG_B64: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p "${{ runner.temp }}/.kube"
          echo "${KUBECONFIG_B64}" | base64 --decode > "${{ runner.temp }}/.kube/kubeconfig.yaml"
          chmod 600 "${{ runner.temp }}/.kube/kubeconfig.yaml"

      - name: Set KUBECONFIG
        run: echo "KUBECONFIG=${{ runner.temp }}/.kube/kubeconfig.yaml" >> $GITHUB_ENV

      - name: Verify cluster (optional)
        run: |
          kubectl cluster-info
          kubectl get ns || true

      - name: Patch image
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} set image deployment/${{ env.WIZARD_DEPLOYMENT }} \
            ${{ env.WIZARD_CONTAINER }}=${{ env.DEV_WIZARD_IMAGE }}:${{ env.SHORT_TAG }} --record

      - name: Wait for rollout
        run: |
          kubectl -n ${{ env.K8S_NAMESPACE }} rollout status deployment/${{ env.WIZARD_DEPLOYMENT }} --timeout=180s

      - name: Cleanup kubeconfig
        if: always()
        run: |
          shred -u ${{ runner.temp }}/.kube/kubeconfig.yaml || rm -f ${{ runner.temp }}/.kube/kubeconfig.yaml
